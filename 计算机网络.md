[TOC]

## 第一章 概述

> 本章重点内容
>
> 1. 互联网边缘部分和核心部分的作用，其中包含分组交换的概念
> 2. 计算机网络的性能指标
> 3. 计算机网络分层次的体系结构，包含协议和服务的概念

#### 1.2 互联网概述

##### 1.2.1 网络中的网络

1. **计算机网络**（简称为**网络**）：由若干**结点**和连接这些结点的**链路**组成。
   1. 结点：可以是计算机、集线器、交换机或者路由器等
2. **互连网**（**网络中的网络**）：通过路由器将网络互连起来，构成的一个覆盖范围更大的计算机网络。
3. 基本概念：网络把许多计算机连接在一起，而互连网则把许多网络通过路由器连接在一起，与网络相连的计算机常称为**主机**。

##### 1.2.2 互联网基础结构发展的三个阶段

1. 第一阶段：从单个网络 ARPANET 向互连网发展的过程
   1. **internet（互连网）是一个通用名词，泛指由多个计算机网络互连而成的计算机网络，**在这些网络间的通信协议（即通信规则）可以任意选择。
   2. **Internet（互联网或因特网）是一个专有名词，它指当前全球最大的、开放的、由众多网络相互连接而成的特定互连网，采用TCP/IP 协议族作为通信的规则，前身是美国的 ARPANET。**
2. 第二阶段：建成了**三级结构的互联网**
   1. 三级计算机网络：**主干网**、**地区网**和**校园网**（或**企业网**）
3. 第三阶段：逐渐形成**多层次ISP结构的互联网**
   1. ISP：互联网服务提供者（或者互联网服务提供商）

#### 1.3 互联网的组成

1. **边缘部分**：由所有连接在互联网上的主机组成，由**用户直接使用**，用来进行通信（传送数据、音频或视频）和资源共享。
2. **核心部分**：由大量的网络和连接这些网络的路由器组成，**为边缘部分提供服务**（提供连通性和交换）

##### 1.3.1 互联网的边缘部分

1. 客户-服务器方式（C/S）：
   1. **客户**和**服务器**都是指通信中涉及的两个应用进程。客户是服务请求方，服务器的服务提供方
2. 对等连接方式（P2P）：
   1. 对等连接（P2P）：指两台主机在通信时不区分客户或者服务器，只要都运行了对等连接软件（P2P软件），就可以进行平等的、对等连接通信。

##### 1.3.2 互联网的核心部分

1. 作用：向网络边缘中的大量主机提供连通性，使边缘部分中的任何一台主机都能够向其它主机通信。
2. 路由器（专用计算机，但是不叫主机）：是实现**分组交换**的关键构件，其任务是**转发收到的分组**。
3. 电路交换：整个保文的比特流连续的从源点直达终点，好像在一个管道中传送；在通话的全部时间内，通话的两个用户始终占用端到端的通信资源。
4. 报文交换：整个报文先传送到相邻结点，全部存储下来后查找转发表，转发到下一个节点。
5. **分组交换**：采用存储转发技术
   1. 报文：把要发送的整块数据称为一个报文。
   2. 过程：在发送报文前，把长报文划分为多个等长数据段，在每个数据段前面，加上一些由必要的控制信息组成的**首部（包头）**          后，构成了一个**分组（包）**。
   3. 互联网的核心采用**网状拓扑结构**。
   4. 单个分组（这只是整个报文的一部分）传送到相邻结点，存储（存储在内存中保证交换速率）下来后查找转发表，转发到下一个结点。

#### 1.5 计算机网络的类别

##### 1.5.1 计算机网络的定义

1. 定义：计算机网络主要由一些通用的**可编程的硬件**（包含中央处理机CPU，如计算机、智能手机）互连而成的。

##### 1.5.2 计算机网络的几种类别

1. 按照网络的作用范围进行分类

   1. 广域网 WAN（Wide Area Network）
   2. 城域网 MAN（Metropolitan Area Network）
   3. 局域网 LAN（Local Area Network）
   4. 个人局域网 PAN（Personal Area Network）

   > 若中央处理机之间距离非常近（<=1 m），一般称为多处理机系统

2. 按照网络的使用者进行分类

   1. 公用网
   2. 私用网

3. 用来把用户接入到互联网的网络

   1. 这种网络就是接入网 AN，又称本地接入网或居民接入网（不属于互联网的核心部分和边缘部分），是从某个用户端系统到互联网中的第一个路由器。



#### 1.6 计算机网络的性能

##### 1.6.1 计算机网络的性能指标

1. 速率：网络技术中的速率指的是**数据的传送速率**，也称为数据率或者比特率，速率单位是 bit/s（比特每秒）。

   > 比特：二进制数字，一个比特就是二进制数字中的一个 1 或 0
   >
   > k = $10^3$ = 千，M = $10^6$，G = $10^9$...
   >
   > **40G 的速率**指的是数据率为 40Gbit/s
   >
   > 字节 B：B 代表 byte，通常一个字节代表 8 个比特
   >
   > **15GB 的数据块以 10G 的速率传送**，表明**有 $15*2^{30}*8$ 比特的数据块**以 $10*10^9$bit/s 的速率传递 

2. 带宽（数据率）

   1. 表示某信道允许通过的频带范围称为该信道的**带宽**（或**通频带**）。

   2. 在计算机网络中，带宽用来表示网络中某**通道**传送数据的能力，单位是**数据率的单位 bit/s**，是 “**比特每秒**”。

      > 网络带宽表示在单位时间内网络中某信道所能通过的“**最高数据率**”。

3. 吞吐量

   1. 表示在单位时间内通过某个网络（或信道、接口）的实际的数据量，受网络的带宽或者网络的额定速率的限制

4. 时延

   1. 定义：指数据（一个报文或分组、比特）从网络（或链路）的一端传送到另一端所需要的时间。

   2. 发送时延：是主机或者路由器发送数据帧所需要的时间

      $$发送时延 = \frac{数据帧长度（bit）}{发送速率（bit/s）}$$

   3. 传播时延：是电磁波在信道中传播一定的距离需要花费的时间

      $$传播时延 = \frac{信道长度（m）}{电磁波在信道上的传播速率（m/s）}$$

   4. 处理时延：主机或者路由器收到分组时需要时间进行处理

   5. 排队时延：分组在经过网络传输时，要经过许多路由器，进入路由器需要在输入队列中排队等待处理

   6. 公式：$总时延 = 发送时延+传播时延+处理时延+排队时延$

   7. ![时延图](E:\TimDownload\课程\fuxi\normal-course\images\计算机网络时延图.png)

5. 时延带宽积

   1. $时延带宽积 = 传播时延 * 带宽$
   2. 比特为单位的链路长度，计算媒体中正在传播的比特数

6. 往返时间 RTT

   1. $发送时间 = \frac{数据长度}{发送速率}$
   2. $有效数据率 = \frac{数据长度}{发送时间+RTT}$

7. 利用率



#### 1.7 计算机网络体系结构

##### 1.7.2 协议和划分层次

1. 网络协议（协议）：为进行网络中的数据交换而建立的规则、标准或约定
   1. 组成：①：语法②：语义⑥：同步
2. 分层的优点
   1. 各层之间是独立的：某层不需要知道他的下一层如何实现，只需要知道该层通过层间的接口（界面）所提供的服务。
   2. 灵活性好
   3. 结构上可分割开
   4. 易于实现和维护
   5. 能促进标准化工作
3. 体系结构：计算机网络的各层及其协议的集合

##### 1.7.3 具有五层协议的体系结构

###### 五层协议

![计算机的网络体系结构](E:\TimDownload\课程\fuxi\normal-course\images\计算机的网络体系结构.png)

1. 应用层
   1. 任务：通过应用进程之间的交互来完成特定网络应用。为特定应用程序提供数据传输服务，例如 HTTP、DNS等
   2. 应用层协议定义的是应用进程（正在运行的程序）间通信和交互的规则
   3. 报文：在应用层交互的数据单元
2. 运输层
   1. 任务：**向两台主机中进程之间的通信提供通用的数据传输服务**
   2. 主要使用协议：
      1. **传输控制协议 TCP**——提供面向连接的、可靠的数据传输服务，其数据传输的单位是**报文段**。TCP 主要提供完整性服务
      2. **用户数据报协议**——提供无连接的、尽最大努力的数据传输服务（不保证数据传输的可靠性），其数据传输的单位是**用户数据报**。UDP 主要提供及时性服务。
3. 网络层（网际层/IP 层）
   1. 任务：负责为分组交换网上的不同主机提供通信服务
   2. 过程：网络层把运输层产生的报文段和用户数据包封装成**分组（IP 数据报 或者 数据报）**或**包**进行传送。
4. 数据链路层
   1. 过程：在两个相邻结点之间传送数据时，数据链路层将网络层交下来的 IP 数据报组装成帧，每一帧包括数据和必要的控制信息。
   2. 进行差错校验
5. 物理层
   1. 物理层上传送的数据的单位是比特
   2. 考虑的是怎样在传输媒体上传输数据比特流，不指具体的传输媒体。物理层的作用是尽可能的屏蔽传输媒体和通信手段的差异，使数据链路层感觉不到这些差异。

###### 七层协议

​	其中表示层和会话层表示如下

1. 表示层：数据压缩、加密以及数据描述。是应用程序之间不必担心各台主机中表示/存储的内部格式不同的问题

2. 会话层：建立及管理会话

   > 五层协议中没有表示层和会话层，而是将这些功能留给应用程序的开发者处理

###### 数据在各层之间的传递过程

> 在向下的过程中，需要添加下层协议所需要的首部或者尾部，而在向上的过程中不断拆开首部和尾部
>
> 路由器只有下面三层协议，因为路由器位于网络核心中，不需要为进程或者应用程序提供服务，因此不需要运输层和应用层

![数据在各层之间的传递过程](E:\TimDownload\课程\fuxi\normal-course\images\数据在各层之间的传递过程.jpg)

###### TCP/IP

> 只有四层，相当于五层协议中数据链路层和物理层合并为网络接口层
>
> 现在的 TCP/IP 体系结构并不严格的遵守 OSI 分层的概念，应用层可能会直接使用 IP 层或者网络接口层

![TCP/IP体系结构的另一种表示方法](E:\TimDownload\课程\fuxi\normal-course\images\TCP IP体系结构的另一种表示方法.png)

> TCP/IP 协议族是一种沙漏形状，中间小两边大

![沙漏计时器形状的TCP IP协议族示意](E:\TimDownload\课程\fuxi\normal-course\images\沙漏计时器形状的TCP IP协议族示意.png)

##### 1.7.4 实体、协议、和服务访问点

1. 实体：表示任何可发送或接收信息的**硬件或者软件进程**。
2. 协议：是控制两个对等实体（或多个实体）进行通信的规则的集合
3. 服务访问点 SAP：在同一系统中相邻两层的实体进行交互（即交换信息）的地方。
4. 协议是水平的，即协议是控制对等实体之间的通信的规则；服务是垂直的，即服务是由下层向上层通过层间接口提供的。
5. 协议和服务的关系：在协议的控制下，上层对下层进行调用，下层对上层进行服务，上下层间交换原语交换信息。同层两个实体间有时有连接。



## 第二章 物理层

> 本章重点内容
>
> 1. 物理层的任务
> 2. 几种常用的信道复用技术
> 3. 几种常用的宽带接入技术，主要是 ADSL 和  FTTx

#### 2.1 物理层的基本概念

1. 物理层的作用是尽可能的屏蔽传输媒体和通信手段的差异，使数据链路层感觉不到这些差异。
2. 数据在计算机内部通常采用并行传输方式，但是在通信线路（传输媒体）上的传输方式一般是串行传输

#### 2.2 数据通信的基本知识

##### 2.2.1 数据通信系统的模型

1. 数据通信系统可划分为三大部分：源系统（或发送端、发送方）、传输系统（或传输网络）和目的系统（或接收端、接收方）。
2. 源系统：
   1. 源点：源点设备产生要传输的数据
   2. 发送器：源点生成的数字比特流要通过发送器编码后才能在传输系统中进行传输。典型的发送器是调制器。现在计算机内置调制解调器（包含调制器和解调器）。
3. 目的系统
   1. 接收器：与源系统发送器对应，接收传输系统的信号，它把来自传输线路上的模拟信号进行解调
   2. 终点
4. 常用术语：
   1. 消息：通信的目的是传送消息，如语音、文字、图像、视频
   2. 数据：运送消息的实体

##### 2.2.2 有关信道的几个基本概念

1. 信道：信道与电路并不等同，信道一般是用来表示向某一个方向传送信息的媒体。一条通信电路包含一条发送信道和一条接收信道。

2. 根据通信的双方信息交互分为三种基本方式

   1. 单向通信（单工通信）：单向传输
   2. 双向交替通信（办双工通信）：双向交替传输
   3. 双向同时通信（全双工通信）：双向同时传输

3. 调制：来自信源的信号常称为基带信号，基带信号含有许多信道不能传输的低频分量或直流分量，为解决这一问题，必须对基带信号进行调制。

4. 调制分类：

   1. 仅对基带信号的波形进行变换，使其与信道特性相适应，变换后依旧是基带信号。称为**基带调制（或编码）**
   2. 使用载波进行调制，把基带信号的频率范围搬移到较高的频段，并转换为模拟信号，称为带通信号，此调制为**带通调制**

5. 常用的编码方式

   1. 不归零制：正电平代表 1，负电平代表 0；
   2. 归零制：正脉冲代表 1，负脉冲代表 0；
   3. 曼彻斯特编码：位于周期中心向上跳代表 0，位于周期中心想下跳代表 1，可以反向定义
   4. 差分曼彻斯特编码：在每一位的中心始终有跳变，位开始边界有跳变代表 0，位开始边界没有跳变代表 1

6. 基本的带通调制方法

   > 模拟信号是连续的信号，数字信号是离散的信号。带通调制把数字信号转换为模拟信号。 

   ![带通调制](E:\TimDownload\课程\fuxi\normal-course\images\带通调制.jpg)

##### 2.2.3 信道的极限容量

1. 信道能够通过的频率范围

   1. 码间串扰：在接收端收到的信号波形失去码元间的清晰界限的现象。
   2. 在任何信道中，码元传输速率是有上限的，传输速率超过此上限，就会出现严重的码间串扰问题，使接收端对码元的判决（识别）成为不可能。

2. 信噪比

   1. 信噪比：信号的平均功率和噪声的平均功率之比，常记为 S/N，度量单位是分贝（db）

      $$信噪比（db） = 10 log_{10}^{(S/N)}（db）$$

   2. 香农公式：信道的带宽或信噪比越大，信息的极限传输速率就越高

      $$信道的极限传输速率 C = W log_{2}^{(1+S/N)}（bit/s）$$

      > W ：信道的带宽（Hz）
      >
      > S：信道内所传信号的平均功率
      >
      > N：信道内部的高斯噪声功率

   

#### 2.4 信道复用技术

##### 2.4.1 频分复用、时分复用和统计时分复用

> 在发送端使用一个复用器，可以让多个单独信道合成一个共享信道进行通信，再在接收端使用分用器，把合起来传输的信息分别发送到相应的终点

1. 频分复用、时分复用

   1. 频分复用的所有用户的相同时间占用不同的频率带宽资源

      ![频分复用](E:\TimDownload\课程\fuxi\normal-course\images\频分复用.jpg)

   2. 时分复用的所用用户在不同的时间占用想同的频率带宽资源

      ![时分复用](E:\TimDownload\课程\fuxi\normal-course\images\时分复用.jpg)

      > 使用这两种方式进行通信，在通信的过程中用户会一直占用一部分信道资源，但是由于计算机数据的突发性质，通信过程中没有必要一直占有信道资源而不让出给其他用户使用，因此这两种方式对信道的利用率都不高

2. 统计时分复用

   > 是对时分复用的一种改进，不固定每个用户在时分复用帧中的位置，只要有数据就集中起来组成统计时分复用帧然后发送

   ![统计时分复用帧](E:\TimDownload\课程\fuxi\normal-course\images\统计时分复用帧.png)

##### 2.4.2 波分复用

1. 光的频分复用。由于光的频率很高，因此习惯上用波长而不是频率来表示所使用的光载波。

   ![波分复用](E:\TimDownload\课程\fuxi\normal-course\images\波分复用.png)

##### 2.4.3 码分复用

![码分复用](E:\TimDownload\课程\fuxi\normal-course\images\码分复用.png)



## 第三章 数据链路层



> 本章重点
>
> 1. 数据链路层的点对点信道和广播信道的特点，以及这两种信道所使用的协议（PPP 协议以及 CSMA/CD 协议）的特点
> 2. 数据链路层的三个基本问题：封装成帧、透明传输、差错检验
> 3. 以太网 MAC 层的硬件地址
> 4. 适配器、转发器、集线器、网桥、以太网交换机的作用和使用的场合

#### 3.1 使用点对点信道的数据链路层

##### 3.1.1 数据链路和帧

1. 链路：从一个结点到相邻结点的一段物理线路（有线或无线），中间无任何其他交换结点
2. 数据链路：在一条线路上传送数据时，需要有一条物理线路和控制这些数据传输必要的通信协议，将实现这些协议的硬件和软件添加到链路上，构成数据链路。实现这些协议常用的方法是使用网络适配器

##### 3.1.2 三个基本问题

1. 封装成帧：将网络层传下来的分组添加首部和尾部，用于标记帧的开始和结束![用帧首部和帧尾部封装成帧](E:\TimDownload\课程\fuxi\normal-course\images\用帧首部和帧尾部封装成帧.jpg)

2. 透明传输：

   1. 透明：某一个实际存在的事物看起来好像不存在一样
   2. 定义：帧使用首部和尾部进行定界，如果帧的数据部分含有和首部尾部相同的内容，那么帧的开始和结束位置就会被错误的判定。需要在**数据部分**出现首部尾部相同的内容前面插入转义字符，如果出现转义字符，那么就在转义字符前面再加个转义字符，在接收端进行处理之后可以还原出原始数据。这个过程透明传输的内容是转义字符，用户察觉不到转义字符的存在。 

   ![用字节填充法解决透明传输的问题](E:\TimDownload\课程\fuxi\normal-course\images\用字节填充法解决透明传输的问题.jpg)

3. 差错检测：目前在数据链路层广泛使用了循环冗余检验 CRC 的差错检验技术



#### 3.2 点对点协议 PPP

##### 3.1.1 PPP 协议的特点

> 互联网用户通常需要连接到某个 ISP 之后才能接入到互联网 ，PPP 协议就是用户计算机和 ISP 进行通信时使用的数据链路层协议

![用户到ISP的链路使用的PPP协议](E:\TimDownload\课程\fuxi\normal-course\images\用户到ISP的链路使用的PPP协议.jpg)

1.  PPP 协议应该满足的要求
2. PPP 协议的组成

##### 3.2.2 PPP 协议的帧格式

1. 各字段的组成

   1.  F 字段为帧的定界符

   2.  A 和 C 字段暂时没有意义

   3.  FCS 字段是使用 CRC 的检验序列

   4. 信息部分的长度不超过 1500

      ![PPP帧格式](E:\TimDownload\课程\fuxi\normal-course\images\PPP帧格式.jpg)

2. 字节填充

   1. 当信息字段中出现和标志字段一样的比特（0x7E）组合时，需要采取一些措施使这种形式上和标志字段一样的比特组合不出现在信息字段中
   2. 当 PPP 使用**异步传输**（逐个字符地传输）时，它把转义字符定义为 0x7D（即 01111101），使用字节填充

3. 零比特填充

   1. 环境：在 SONET/SDH 链路时，使用**同步传输**（一连串的比特连续传送）

##### 3.2.3 PPP 协议的工作状态

#### 3.3 使用广播信号的数据链路层

##### 3.2.2 CSMA/CD 协议

1. 用于广播信道中，在广播信道上，同一时间只允许一台计算机发送数据

2. CSMA/CD 表示载波监听多点接入/碰撞检测：

   1. 多点接入：说明这是总线型网络，许多计算机以多点的方式连接到总线上
   2. 载波监听：每个站都必须不停的监听信道，在发送前，如果监听到信道正在使用，就必须等待
   3. 碰撞检测：在发送中，如果监听到信道已有其他站在发送数据，就表示发生了碰撞，虽然每一个站在发送数据之前都已经监听到信道为空闲，但是由于电磁波的传播时延的存在，还是有可能会发生碰撞。

3. 记端到端的传播时延为 τ ，最先发送的站点最多经过 2τ  就可以知道是否发生了碰撞，称 2τ  为**争用期**，只有经过争用期之后还没有检测到碰撞，才能肯定这次发送不会发生碰撞。当发生碰撞时，站点要停止发送，等待一段时间再发送。这个时间采用**截断二进制指数退避算法**来确定，从离散的整数集合 {$0,1,...,(2^k-1)$} 中随机取出一个数，记作 r，然后取 r 倍的争用期作为重传等待时间

   ![传播时延对载波监听的影响](E:\TimDownload\课程\fuxi\normal-course\images\传播时延对载波监听的影响.png)

   

##### 3.3.5 以太网的 MAC 层

1. MAC 层的硬件地址

   1. 在局域网中，**硬件地址**又称为**物理地址**或者 **MAC 地址**（此种地址在 MAC 帧中）
   2. 名字指出我们要寻找的那个资源，地址指出那个资源在何处，路由告诉我们如何到达

2. MAC 帧的格式

   1. MAC 帧是 6 字节（48 位）的地址，用于唯一标识网络适配器（网卡），一台主机拥有多少个适配器就有多少个 MAC 地址，例如笔记本电脑普遍存在无线网络适配器和有线网络适配器，因此就有两个 MAC 地址。

      ![以太网V2的MAC帧格式](E:\TimDownload\课程\fuxi\normal-course\images\以太网V2的MAC帧格式.jpg)

   2. MAC 帧

      1. 类型：标记上层使用的协议
      2. 数据：长度在 46~1500 之间，如果太小则需要填充
      3. FCS：帧检验序列，使用的是 CRC 检验方法
      4. 前同步代码：只是为了计算 FCS 临时加入的，计算结束后会丢弃


#### 3.4 扩展的以太网

   ##### 3.4.1 在物理层扩展以太网

   1. 使用集线器进行扩展

   2. 集线器的主要功能是对接接收到的信号进行放大，以扩大网络的传输距离，集线器不能根据 MAC 地址进行转发，而是以广播的方式发送数据帧。集线器是一种共享的传输设备，意味着统一时刻只能传输一组数据帧

      ![用多个集线器连接成更大的以太网](E:\TimDownload\课程\fuxi\normal-course\images\用多个集线器连接成更大的以太网.jpg)

   ##### 3.4.2 在链路层进行扩展

1. 最开始是网桥，它收到一个帧时，根据帧的 MAC 地址，查找网桥中的地址表，确定帧转发的接口。网桥不是共享式设备，因此性能比集线器这种共享式设备更高。

2. 交换机淘汰了网桥，它实质上是一个多接口网桥，而网桥是两接口。交换机的每个接口都能直接与一个主机或者另一个交换机相连，并且一般都工作在全双工方式。

3. 交换机具有自学习能力，学习的是交换表的内容。交换表中存储着 MAC 地址到接口的映射。下图中，交换机有 4 个接口，主机 A 向主机 B 发送数据帧时，交换机把主机 A 到接口 1 的映射写入交换表中。为了发送数据帧到 B，先查交换表，此时没有主机 B 的表项，那么主机 A 就发送广播帧，主机 C 和主机 D 会丢弃该帧。主机 B 收下之后，查找交换表得到主机 A 映射的接口为 1，就发送数据帧到接口 1，同时交换机添加主机 B 到接口 3 的映射。 

   ![以太网交换机中的交换表](E:\TimDownload\课程\fuxi\normal-course\images\以太网交换机中的交换表.jpg)



##### 3.4.3 虚拟局域网

1. 虚拟局域网可以建立与物理位置无关的逻辑组，只有在同一个虚拟局域网中的成员才会收到链路层广播信息，例如下图中 (A1, A2, A3, A4) 属于一个虚拟局域网，A1 发送的广播会被 A2、A3、A4 收到，而其它站点收不到。

   ![三个虚拟局域网的构成](E:\TimDownload\课程\fuxi\normal-course\images\三个虚拟局域网的构成.png)







## 第四章 网络层

> 本章重点：
>
> 1. 虚拟互连网络的概念
> 2. IP 地址和物理地址的关系
> 3. 传统分类的 IP 地址（包括子网掩码）和无分类域间路由选择 CIDR
> 4. 路由选择协议的工作原理

#### 4.1 网络层提供的两种服务

1. 设计思路：网络层向上值提供简单灵活的、无连接的、尽最大努力交付的数据报服务，网络层不提供服务质量的保证

#### 4.2 网际协议 IP 

1. 与 IP 协议配套使用的三个协议

   1. 地址解析协议 ARP 

   2. 网际控制报文协议 ICMP

   3. 网际组管理协议 IGMP

      ![网际协议IP及其配套协议](E:\TimDownload\课程\fuxi\normal-course\images\网际协议IP及其配套协议.png)

##### 4.2.1 虚拟互连网络

1. 使网络互连的中间设备

   1. 物理层——转发器
   2. 数据链路层——网桥或桥接器
   3. 网络层——路由器
   4. 网络层以上——网关，用网关连接两个不兼容的系统需要在高层中进行协议转换

2. 使用 IP 协议，可以把异构的物理网络连接起来，使得在网络层看起来好像是一个统一的网络，**互联网可以由多种异构网络互连组成**

   ![IP网概念](E:\TimDownload\课程\fuxi\normal-course\images\IP网概念.jpg)

##### 4.2.2 分类的 IP 地址

1. IP 地址及其表示方法

   1. 三个阶段

      1. 分类的 IP 地址
      2. 子网的划分
      3. 构成超网

   2. 分类：由两部分组成，网络号和主机号，其中不同分类具有不同的网络号长度，并且是固定的。一个 IP 地址在**整个互联网的范围内是唯一的**。

      ![IP地址中的网络号字段和主机号字段](E:\TimDownload\课程\fuxi\normal-course\images\IP地址中的网络号字段和主机号字段.png)

2. 常用的三种类别的 IP 地址

   1. IP 地址的指派范围

      | 网络类别                            | 最大可指派的网络数 | 第一个可指派的网络号 | 最后一个可指派的网络号 | 每个网络中最大的主机数 |
      | :-----------------------------------: |: ------------------ :| :--------------------: |: ---------------------- :|: ---------------------- :|
      |A | $126(z^7-1)$|1|126|16777214|
      |B | $16383(2^14-1)$|128.1|191.255|65534|
      |C| $2097151(2^21-1)$|192.0.1|233.255.255|254|

   2. IP 地址是一种分等级的地址结构，IP 地址管理机构值分配网络号，主机号由得到网络号的单位自行分配；路由器仅根据目的主机所连接的网络号来转发分组


##### 4.2.3 IP地址与硬件地址
1. 从层次角度看：物理地址是数据链路层和物理层使用的地址，而 IP 地址是网络层和以上各层使用的地址，是一种逻辑地址。

	.	在 IP 层抽象的互联网上只能看到 IP 数据报

	.	IP 数据报首部有源站的 IP 地址，但是路由器只能根据目的站的 IP 地址的网络号进行路由选择

	.	在局域网的链路层上，只能看见 MAC 地址。

	.	尽管互连在一起的网络的硬件和软件地址体系各不相同，但 IP 层抽象的互联网屏蔽了下层这些很复杂的细节

	.	**网络层实现主机之间的通信，而链路层实现具体的每段链路之间的通信。因此在通信过程中，IP 数据报的原地址和目的地址始终不变，而 MAC 地址随着链路的改变而改变**

   ![网络配置](E:\TimDownload\课程\fuxi\normal-course\images\网络配置.jpg)

##### 4.2.4 地址解析协议 ARP

1. 作用：实现由 IP 地址得到 MAC 地址

   ![ARP协议的作用](E:\TimDownload\课程\fuxi\normal-course\images\ARP协议的作用.jpg)

2. 每个主机都有一个 ARP 高速缓存，里面有本局域网上的各主机和路由器的 IP 地址到硬件地址的映射表

3. 如果主机 A 知道主机 B 的 IP 地址，但是 ARP 高速缓存中没有该 IP 地址到 MAC 地址的映射，此时主机 A 通过广播的方式发送 ARP 请求分组，主机 B 收到该请求后会发送 ARP 响应分组给主机 A 告知其 MAC 地址，随后主机 A 向其高速缓存中写入主机 B 的 IP 地址到 MAC 地址的映射

   ![地址解析协议ARP的工作原理](E:\TimDownload\课程\fuxi\normal-course\images\地址解析协议ARP的工作原理.png)



##### 4.2.5 IP 数据报格式

![IP数据报格式](E:\TimDownload\课程\fuxi\normal-course\images\IP数据报格式.jpg)

1. 版本：有 4（IPv4）和 6（IPv6）两个值；

2. 首部长度：占四位，因此最大长度为 15，值为 1 表示 1 个 32 为字的长度，也就是 4 字节。因为首部固定长度为 20 字节，因此该值最小为 5。如果可选字段的长度不是 4 字节的整数倍，就用尾部的填充部分来填充。

3. 区分服务 : 用来获得更好的服务，一般情况下不使用。

4. 总长度 : 包括首部长度和数据部分长度。

5. 生存时间 ：TTL，它的存在是为了防止无法交付的数据报在互联网中不断兜圈子。以路由器跳数为单位，当 TTL 为 0 时就丢弃数据报。

6. 协议 ：指出携带的数据应该上交给哪个协议进行处理，例如 ICMP、TCP、UDP 等。

7. 首部检验和 ：因为数据报每经过一个路由器，都要重新计算检验和，因此检验和不包含数据部分可以减少计算的工作量。

8. 标识 : 在数据报长度过长从而发生分片的情况下，相同数据报的不同分片具有相同的标识符。

9. 片偏移 : 和标识符一起，用于发生分片的情况。片偏移的单位为 8 字节。

   ![数据报的分片举例](E:\TimDownload\课程\fuxi\normal-course\images\数据报的分片举例.png)



#### 4.3 划分子网和构造超网

##### 4.3.1 划分子网

1. 从两级 IP 地址到三级 IP 地址

   1. 缺点：

      1. IP 地址空间的利用率有时很低
      2. 给每一个物理网络分配一个网络号会使路由表变得太大破坏网络性能
      3. 两级 IP 地址不够灵活

   2. 划分子网（子网寻址或子网路由选择）

      1. 外部网络看不到子网

      2. 通过在主机号字段拿一部分作为子网号，把两级 IP 地址划分为 三级 IP 地址。

         IP 地址 :: = {<网络号>，<子网号>，<主机号>}

2. 子网掩码

   1. 从 IP 数据报的首部无法看出源主机或者目的主机所连接的网络是否进行了子网划分，32 位的 IP 地址及其数据报首部未包含与子网划分有关的信息，使用子网掩码。
   2. 要使用子网，必须配置子网掩码。一个 B 类地址的默认子网掩码为 255.255.0.0，如果 B 类地址的子网占两个比特，那么子网掩码为 11111111 11111111 11000000 00000000，也就是 255.255.192.0。
   3. 子网的网络地址 = 子网的掩码与收到的数据报的目的 IP 地址逐位相与（AND）。
   4. 划分子网增加了灵活性，但却减少了能够连接在网络上的主机数

##### 4.3.2 使用子网时分组的转发

1. 使用子网掩码后，路由表必须包含以下三项内容：
   1. 目的网络地址
   2. 子网掩码
   3. 下一跳地址

##### 4.3.3 无分类编址 CIDR （构造超网）

1. 无分类编址（无分类域间路由选择 CIDR）：

   1.  CIDR 消除了传统的 A 类、B 类和 C 类地址以及划分子网的概念，使用网络前缀和主机号来对 IP 地址进行编码，网络前缀的长度可以根据需要变化

      IP 地址 :: = {<网络前缀号>，<主机号>}

      CIDR 的记法上采用在 IP 地址后面加上网络前缀长度的方法，例如 128.14.35.7/20 表示前 20 位为网络前缀。

   2. CIDR 把网络前缀都相同的连续的 IP 地址组成一个 “CIDR 地址块”。

   3. CIDR 的地址掩码可以继续称为子网掩码，斜线记法中，斜线后面的数字就是地址掩码中 1 的个数。

   4. 一个 CIDR 地址块中有很多地址，一个 CIDR 表示的网络就可以表示原来的很多个网络，并且在路由表中只需要一个路由就可以代替原来的多个路由，减少了路由表项的数量。把这种通过使用网络前缀来减少路由表项的方式称为路由聚合，也称为**构成超网**。

2. 最长前缀匹配前缀

   1. 在路由表中的项目由“网络前缀”和“下一跳地址”组成，在查找时可能会得到不止一个匹配结果，应当采用最长前缀匹配来确定应该匹配哪一个。



#### 4.4 网际控制报文协议 ICMP

1. ICMP 是为了更有效的转发 IP 数据报和提高交付成功的机会，它会封装在 IP 数据报中，但是不属于高层协议。

   ![ICMP 报文格式](E:\TimDownload\课程\fuxi\normal-course\images\ICMP 报文格式.jpg)

##### 4.4.1 ICMP 报文的种类

![几种常用的ICMP报文类型](E:\TimDownload\课程\fuxi\normal-course\images\几种常用的ICMP报文类型.png)

#### 4.5 互联网的路由选择协议

##### 4.5.1 有关路由选择的几个基本概念

1. 互联网把路由选择协议划分为两大类
   1. 内部网关协议 IGP：即在一个自治系统内部使用的路由选择协议
   2. 外部网关协议 EGP：

##### 4.5.2 内部网关协议 RIP

1. 工作原理
   1. RIP 是一种分布式的基于距离向量的路由选择协议
   2. RIP 协议的距离指条数，直接相连的路由器跳数为 1 ，跳数最多为 15，超过 15 代表不可达。
   3. RIP 按固定时间间隔仅和相邻路由器交换自己的路由表，经过若干交换之后，所有的路由最终会知道到达本自治系统中任何一个网络的最短距离和下一跳路由器地址。
2. 距离向量算法
   1. 对地址为 x 的相邻路由器发来的 RIP 报文，先修改报文中的所有项目，把下一跳的地址改为 x，并把所有的距离字段加 1；
   2. 对修改后的 RIP 报文中的每一个项目，进行一下步骤
      1. 若原来的路由表中没有目的网路 N，则把改项目添加到路由表中
      2. 否则：若下一跳路由器地址是 x ，则把收到的项目替换原来路由表中的项目；否则：若收到的项目中的距离 d 小于路由表中的距离，则进行更新（例如原始路由表项为 Net2, 5, P，新表项为 Net2, 4, X，则更新）；否则什么也不做。
      3. 若 3 分钟还没有收到相邻路由器的更新路由表，则把该相邻路由器标为不可达，即把距离置为 16。
3. 优点：
   1. RIP 协议实现简单，开销小，但是 RIP 能使用的最大距离为 15，限制了网络的规模。并且当网络出现故障时，要经过比较长的时间才能将此消息传送到所有路由器

##### 4.5.3 内部网关协议 OSPF

1. 开放最短路径优先 OSPF，为了克服 RIP 的缺点而开发出来的
2. 开放表示 OSPF 不受某一家厂商控制，而是公开发表的；最短路径优先表示了使用了 Dijkstra 提出的最短路径算法 SPF。
3. 特点：

   1.  向本自治系统中的所有路由器发送信息，这种方法是洪泛法。
   2. 发送的信息就是与相邻路由器的链路状态，链路状态包括与哪些路由器相连以及链路的度量，度量用费用、距离、时延、带宽等来表示。
   3. 只有当链路状态发生变化时，路由器才会发送信息。
4. 所有路由器都具有全网的拓扑结构图，并且是一致的。相对于 RIP ， OSPF 的更新过程收敛的很快

##### 4.5.4 外部网关协议 BGP





## 第五章 运输层

## 第六章 应用层



